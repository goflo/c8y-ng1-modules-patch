"use strict";function _slicedToArray(n,e){return _arrayWithHoles(n)||_iterableToArrayLimit(n,e)||_unsupportedIterableToArray(n,e)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(n,e){if(n){if("string"==typeof n)return _arrayLikeToArray(n,e);var t=Object.prototype.toString.call(n).slice(8,-1);return"Object"===t&&n.constructor&&(t=n.constructor.name),"Map"===t||"Set"===t?Array.from(n):"Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t)?_arrayLikeToArray(n,e):void 0}}function _arrayLikeToArray(n,e){(null==e||e>n.length)&&(e=n.length);for(var t=0,r=new Array(e);t<e;t++)r[t]=n[t];return r}function _iterableToArrayLimit(n,e){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(n)){var t=[],r=!0,o=!1,i=void 0;try{for(var a,c=n[Symbol.iterator]();!(r=(a=c.next()).done)&&(t.push(a.value),!e||t.length!==e);r=!0);}catch(n){o=!0,i=n}finally{try{r||null==c.return||c.return()}finally{if(o)throw i}}return t}}function _arrayWithHoles(n){if(Array.isArray(n))return n}!function(){function sn(n,e,o,i,a,c,u,d,l,t,r,s,f,h,p,g,v){var m=n("dashboards"),b=n("dashboardLists"),y="c8y_Dashboard",C={welcome:{icon:"cloud",name:p.getString("Welcome")},home:{icon:"home",name:p.getString("Home")}};function x(n){return _.map(n,function(n){return _.assign(_.get(n,y,{}),{id:n.id})})}function T(n){var e=n||{},t=_.assign(_.get(e,y,{}),{id:e.id},function(n){var t=/^c8y_Dashboard!(.+)$/;return _.pickBy(n,function(n,e){return t.test(e)})}(e));return _.set(t,"global",!!_.get(e,"c8y_Global")),function(n){var e=["templateUrl","configTemplateUrl"],t=_.map(n.children,function(n){return c.all(_.map(e,_.partial(w,n)))});return c.all(t).then(function(){return n})}(t).then(R)}function R(e){return e.children?function(n){return r.list().then(function(e){return _(n).mapValues(function(n){return D(n,e,!1)}).value()})}(e.children).then(function(n){return e.children=n,e}):e}function D(n,e,t){var r=_.cloneDeep(n),o=_.find(e,function(n){var e=n.name&&n.name===r.name,t=n.templateUrl&&n.templateUrl===r.templateUrl;return e||t});if(o){var i=o.replaceWith;return i&&(r.config=u.invoke(i.config,void 0,{oldConfig:r.config}),o=_.find(e,{name:i.component})),r.name=o.name,o.transformConfigWithContext&&(r.componentTransformConfigWithContext=o.transformConfigWithContext),o.widgetComponent?(r.widgetComponent=o.widgetComponent,delete r.templateUrl):r.templateUrl=o.templateUrl,o.configComponent?(r.configComponent=o.configComponent,delete r.configTemplateUrl):r.configTemplateUrl=o.configTemplateUrl,r}return t?null:r}function A(e){return s.canAdminMOs([e]).then(function(n){return n||(e.isFrozen=!n),e.readOnly=!n,e})}function I(n){return _.get(n,"isFrozen")}function E(n){return O(n,!0)}function L(n){return O(n,!1)}function O(n,e){return n.isFrozen=e,ln.saveAndWait(n).then(sn.clearCacheList)}function w(e,t){var n=e[t];return f.verifyPluginViewPath(n).then(function(n){return e[t]=n,e})}function S(t){return function(n){var e=_.isObjectLike(n)?n.id:n;return[y,t,e].join("!")}}var U=S("device"),P=S("group"),N=S("name"),k=S("type");function W(n){return m.put($(n),_.cloneDeep(n))}function $(n){return _.isObjectLike(n)?n.id:n}function j(n,e){var t,r=_.assign(n||{},{fragmentType:e||y}),o=l.list(r).then(x);return e&&!n&&(t=b.get(e),o.then(function(n){0<n.length&&b.put(e,n)})),t?c.when(t):o}function G(){b.removeAll(),e.$emit("dashboard:refresh")}function M(n,e,t){var r=m.get($(n)),o=!(t&&r)&&l.detail(n).then(d.getResData).then(T).then(A).then(W);return(r?c.when(r):o).then(F).then(z(e))}function z(t){return function(n){var e=n;return(e.deviceType||t)&&(e=function(n){return un().then(_.partial(H,n))}(_.cloneDeep(e))),e}}function H(n,e){return c.all(_.map(n.children,function(n){return V(e,n.config)})).then(_.constant(n))}function V(e,n){var t=function(n){n.__target={id:e.id,name:e.name}};return n&&(n.device={id:e.id,name:e.name},n.datapoints&&_.forEach(n.datapoints,t),n.alarmsEventsConfigs&&_.forEach(n.alarmsEventsConfigs,t),n.options&&n.options.dataPoints&&_.forEach(n.options.dataPoints,t),n.datapointsGauge&&_.forEach(n.datapointsGauge,t),n.datapointsLabels&&_.forEach(n.datapointsLabels,t)),n}function F(t){return un().then(function(e){return c.all(_.map(t.children,function(n){return B(e,t,n)}))}).then(_.constant(t))}function B(t,r,e){var n=e.config||{},o=_.compact([e.transformConfigWithContext,e.componentTransformConfigWithContext]);return _.reduce(o,function(n,e){return n.then(function(n){return u.invoke(e,null,{config:n,context:t,dashboard:r})})},c.resolve(n)).then(function(n){return _.assign(e,{config:n})})}function Y(n){return r.list().then(function(e){return _(n).map(function(n){return D(n,e,!0)}).compact().value()})}function q(t,n){_.forEach(n,function(n,e){t[e]&&(t[e]=n(t[e]))})}function J(n,e,t){return _.forEach(n,function(n){n.__target=K(n.__target,e,t)}),n}function K(n,e,t){return n&&n.id===t.id&&_.assign(n,_.pick(e,["id","name"])),n}function Q(n){var t=["id","creationContext","readOnly"],r=/^c8y_Dashboard!/,e=_.cloneDeep(n);e.global=!!e.deviceType||e.global;var o,i=e.id,a={id:i},c=i?"update":"createConfirm";a[y]=_.pickBy(e,function(n,e){return!r.test(e)&&!_.includes(t,e)}),function(n){n[y].global&&_.assign(n,{c8y_Global:{}})}(a);var u=e.deviceType?{}:e.creationContext;return o=l[c](a,u),"update"==c&&(o=o.then(function(){return n})),"createConfirm"==c&&(o=o.then(d.getResData).then(T)),o.then(W)}function X(n,e,t,r){var o={id:t.id},i=n(e);return o[i]=r?null:{},m.get(i)&&m.remove(i),l.save(o)}function Z(n,e){return j(null,n(e))}function nn(){if(ln.forcedContext)return ln.forcedContext;var t=null,r=null;return _.forEach(["report","device","group"],function(n){var e=_.get(o,"".concat(n,"Id"));e&&(t=n,r=e)}),{context:t,id:r}}function en(n,e){var t={templateUrl:":::PLUGIN_PATH:::/dashboardWidget/config.html",controller:"DashboardWidgetConfigController",size:"lg",resolve:{dashboard:function(){return e||{}},component:function(){return n||{}},hideTarget:function(){return e&&e.deviceType}}};return i.open(t).result}function tn(n,r){var e={template:'<div ng-include="\':::PLUGIN_PATH:::/dashboard/new.html\'" ng-controller="DashboardEditCtrl"></div>',controller:["$scope","$uibModalInstance","config",function(n,e,t){n.dashboardId="new",n.modalInstance=e,n.config=t||{},n.creationContext=r}],size:"lg",resolve:{config:_.constant(n)}};return i.open(e).result}function rn(n,e){return function(n){var e={templateUrl:":::PLUGIN_PATH:::/dashboard/select.html",controller:"DashboardSelectController",size:"lg",resolve:{config:_.constant(n)}};return i.open(e).result}(angular.extend({title:h("Select dashboard"),preventNew:!0,selectLabel:h("Select"),useReports:!0},e)).then(function(t){return n.templateUrl?an(t,n):Y([n]).then(function(n){var e=_slicedToArray(n,1)[0];return an(t,e)})})}var on={};function an(n,e,t){var r=n.id||n;on[r]=on[r]||{children:[]};var o=on[r],i=o.promise;return o.children.push({child:e,remove:t}),i||(o.promise=a(function(){return c.all({dashboard:M(n,!1,!0),contextObject:un()}).then(function(n){var t=n.dashboard,r=n.contextObject;return c.all(_.map(o.children,function(e){return(e.remove?c.resolve(e.child):B(r,t,e.child)).then(function(n){t.children=cn(t.children||{},n,e.remove)})})).then(_.constant(t))}).then(Q)}),(i=o.promise).finally(function(){delete on[r]})),i}function cn(n,e,t){return e.id||(e.id=String(Math.random()).substr(2)),t?delete n[e.id]:n[e.id]=e,function(n){var e=0;return _(n).sortBy("position").forEach(function(n){n.position=e,e+=1}),_.cloneDeep(n)}(n)}function un(){var e=nn();return e.id?t.detailCached(e.id,{withChildren:!1}).then(d.getResData).then(function(n){return n||{id:e.id}}):c.when({})}var dn=[];var ln={list:j,save:Q,saveAndWait:_.partialRight(Q,!0),detail:M,detailPredefinedReadOnly:function(n,e){var t={children:{},isFrozen:!0,readOnly:!0};return Y(n).then(function(n){return _.forEach(n,function(n){cn(t.children,n)}),t}).then(F).then(z(e))},named:function(e,r,o){var i=function(n){return Q(n).then(_.partial(X,N,e)).then(d.getResData).then(function(n){return M(n,o)})};return j(null,N(e)).then(function(n){var e;if(n.length)e=M(_.head(n).id,o);else{var t={children:{}};e=Y(r).then(function(n){return _.forEach(n,function(n){cn(t.children,n)}),s.hasAnyRole(["ROLE_INVENTORY_ADMIN","ROLE_INVENTORY_CREATE"]).then(function(n){return!!n||c.reject()}).then(_.partial(i,t)).catch(_.partial(_.identity,t))})}return e})},isNamed:function(n){return _.some(_.keys(n),function(n){return/^c8y_Dashboard!name!/.test(n)})},remove:function(n){return m.remove($(n)),e.$emit("dashboard:remove",$(n)),l.remove(n)},isLocked:I,toggleLock:function(n){return I(n)?L(n):E(n)},lock:E,unlock:L,deviceAdd:_.partial(X,U),deviceRemove:_.partialRight(_.partial(X,U),!0),deviceList:_.partial(Z,U),deviceTypeAdd:_.partial(X,k),deviceTypeRemove:_.partialRight(_.partial(X,k),!0),deviceTypeList:function(n){return c.all([Z(U,n.id),Z(k,n.type)]).then(_.flattenDeep)},groupAdd:_.partial(X,P),groupRemove:_.partialRight(_.partial(X,P),!0),groupList:_.partial(Z,P),getContextObject:un,transformChildWithContext:B,updateConfigTargetsWithContext:V,addDashboard:tn,copyDashboard:function(n){var e,t=function(n){var e=nn(),r=e.id;function o(n){return n.__target.id!==r}if("device"!==e.context&&"group"!==e.context)return h("Only dashboards from devices or groups can be copied");if(!_.every(n.children,function(n){var e=n.config||{},t=!0;return e.device&&e.device.id!==r&&(t=!1),e.datapoints&&_.some(e.datapoints,o)&&(t=!1),t})){if("device"===e.context)return h("Only dashboards with widgets referencing the current device can be copied.");if("group"===e.context)return h("Only dashboards with widgets referencing the current group can be copied.")}return!1}(n);if(t)return g.warning(t),!1;dn=[];var r=nn();return dn.push({dashboard:_.cloneDeep(n),context:r}),"device"===r.context&&(e=h('Dashboard copied. Navigate to the desired device and select "Paste dashboard"')),"group"===r.context&&(e=h('Dashboard copied. Navigate to the desired group and select "Paste dashboard"')),g.success(e),!0},pasteDashboard:function(){if(dn&&dn.length)return un().then(function(n){if(!function(n){var e,t=nn(),r=n.context.context;return t.context!==r&&("device"===r&&(e=h("Device dashboards can only be copied into a device.")),"group"===r&&(e=h("Group dashboards can only be copied into a group."))),e&&g.warning(e),!e}(_.last(dn)))return!1;var e=dn.pop(),t=e.dashboard,r=nn();r.name=n.name;var o=ln["".concat(r.context,"Add")];_.forEach(t,function(n,e){e.match(/!/)&&delete t[e]});var i=r.context;r.context===e.context.context&&["device","group"].includes(i)&&(t=function(n,i,a){var e=_.reduce(n.children,function(n,e){var t=e.id,r=e.config,o={device:function(n){return K(n,i,a)},datapoints:function(n){return J(n,i,a)},dataPoints:function(n){return J(n,i,a)},datapointsGauge:function(n){return J(n,i,a)},datapointsLabels:function(n){return J(n,i,a)}};return r&&(q(r,o),r.options&&q(r.options,o)),n[t]=e,n},{});return n.children=e,n}(t,r,e.context)),t.creationContext=r,delete t.id;var a=Q(t);return a.then(function(n){return o(r.id,n)}).finally(G),a})},dashboardToPaste:function(){var n=dn&&dn[0];return n&&n.dashboard},selectDashboard:tn,editCurrentDashboard:function(t){var n={template:'<div ng-include="\':::PLUGIN_PATH:::/dashboard/new.html\'" ng-controller="DashboardEditCtrl"></div>',controller:["$scope","$uibModalInstance",function(n,e){n.modalInstance=e,n.dashboardId=_.get(t,"dashboardId")}],size:"lg"};return i.open(n).result},editChildUI:en,addChildUI:_.partial(en,null),restoreDefaultChildren:function(t,n,r){return Y(n).then(function(n){var e=t.children;return _.forEach(_.keys(e),function(n){cn(e,e[n],!0)}),_.forEach(n,function(n){cn(e,n)}),Q(t).then(function(n){return M(n,r)})})},getContext:nn,getContextPath:function(){var n=nn(),e="";return"group"===n.context&&(e="/group/".concat(n.id)),"device"===n.context&&(e="/device/".concat(n.id)),e},appendChild:_.partialRight(an,!1),updateChild:_.partialRight(an,!1),removeChild:_.partialRight(an,!0),clearCacheList:G,addWidgetToSelectedDashboard:rn,addWidgetToSelectedDashboardInContext:function(n){return rn(n,{inContext:!0,preventCreate:!0,useReports:!1})},addWidgetToSelectedReport:function(n){return rn(n,{onlyReports:!0,useReports:!0,title:h("Select report"),preventCreate:!0})},getIconNameObj:function(n){var e={icon:n.icon||"th",name:n.name||p.getString("Dashboard")},t=function(n){var t=/^c8y_Dashboard!name!(.+?)[-_].+$/,e=_.pickBy(n,function(n,e){return t.test(e)}),r=_.keys(e);if(0<r.length){var o=r[0].match(t);return o[1]}return null}(n),r=d.getPluginService("c8yReports");if(t){var o=C[t];o&&(e.icon=o.icon||e.icon,e.name=o.name||e.name)}return"report"===t&&r&&(e=r.getReportFromDashboard(n).then(function(n){return _.pick(n,["icon","name"])})),c.resolve(e)},hasWritePermissions:function(n){return d.hasId(n)?s.canAdminMOs([n]):s.hasAnyRole(["ROLE_INVENTORY_ADMIN","ROLE_INVENTORY_CREATE"])},VERSION:2};return _.assign(ln,v)}sn.$inject=["$cacheFactory","$rootScope","$routeParams","$uibModal","$timeout","$q","$injector","c8yBase","dashboardInventorySvc","c8yInventory","c8yComponents","c8yPermissions","c8yUiUtil","gettext","gettextCatalog","c8yAlert","c8yDashboardStyle"],angular.module("c8y.parts.dashboard2").factory("dashboardSvc",sn)}();