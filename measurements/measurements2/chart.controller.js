"use strict";!function(){function t(o,a,n,t){var e,s,l,i,m,r=_.debounce(f,300,{leading:!1,trailing:!0}),c=12e4,d=!1,u=t("Realtime is active. Deactivate it to edit date and time.");function f(){s&&l.dateFrom&&l.dateTo&&(d=!0,s.loadData(l.dateFrom,l.dateTo,o.aggregation).then(p).finally(function(){d=!1,o.onDataChange({chart:s})}))}function D(t){s.realtimeMeasurement(t)&&(h(),p(),o.selectable()&&(g(e),o.selected&&s.setSelectPoint(o.selected)))}function p(){e=moment()}function h(){!d&&moment().diff(e)>c&&f()}function g(t,e){var a=e||{},n=moment(t),o=moment.duration(moment(l.dateTo).diff(l.dateFrom)),i=moment(n).subtract(o);l.dateFrom=i.toDate(),l.dateTo=n.toDate();var r=l,c=r.dateFrom,d=r.dateTo;a.notrigger&&(m=!0),s.axisX.updateDates(c,d,!1),a.loadData&&f()}var $={dateFrom:!1,dateTo:!1,aggregation:!1,datapoints:!1};function T(t){t&&($[t]=!0),_.every($,function(t){return!0===t})&&r()}function v(){h(),moment(s.axisX._to).isBefore(moment())&&!s.allowSelectFocusTime&&g(moment(),{notrigger:1})}function F(){return _.map(o.datapoints,function(t,e){return{id:e,name:t.label,datapoint:t,datapointActive:t.__active}})}function w(t){o.seriesSelected=t;var e=_.map(o.seriesSelected,"datapoint");s.updateSeries(e,!0)}this.init=function(t){s=t,o.chart=s,l={},o.internalDates=l,i=n(v),s.axisX.onUpdateDates=function(t,e){l.dateFrom=t,l.dateTo=e},o.$watch("dateFrom",function(t){moment(o.internalDates.dateFrom).isSame(t)||(o.internalDates.dateFrom=new Date(t),s.axisX.updateDates(t,o.dateTo,!1),T("dateFrom"))}),o.$watch("dateTo",function(t){moment(o.internalDates.dateTo).isSame(t)||(o.internalDates.dateTo=new Date(t),s.axisX.updateDates(o.dateFrom,t,!1),T("dateTo"))}),o.$watch("internalDates",function(t,e){var a=t.dateFrom&&moment(t.dateFrom).toDate(),n=t.dateTo&&moment(t.dateTo).toDate();o.datesValid=a&&n&&a<=n,o.datesValid&&(o.onUpdateDisplayedDates&&o.onUpdateDisplayedDates({$dateFrom:a,$dateTo:n}),m?m=!1:t!==e&&o.onUpdateDates&&(o.onUpdateDates({$dateFrom:a,$dateTo:n}),s.axisX.updateDates(a,n,!1),o.realtime||r()))},!0),o.$watch("aggregation",function(){return T("aggregation")}),o.$watch("datapoints",function(){o.seriesAvailable=F(),o.seriesSelected?w(_.filter(o.seriesAvailable,"datapointActive")):w(function(){var t=_.filter(F(),"datapointActive"),e=o.datapointsInitialDisplayLimit;return _.isUndefined(e)?t:_.take(t,e)}())},!0),o.$watchCollection("datapoints",function(){return T("datapoints")}),o.$watch("realtime",function(t){t&&!o.selectable()?(g(moment(),{notrigger:1,loadData:1}),i.start()):i.cancel()}),o.$watch("selected",function(t){t?s.setSelectPoint(t):s.clearSelectPoint()}),s.onSelectPoint=function(t){a(function(){o.selected=t})},o.$watch(function(){return o.selectable()},function(t){(s.allowSelectFocusTime=t)&&i.cancel()}),o.$watch("chart.chartBox",function(t,e){_.isEqual(t,e)||o.onBoxChanged({box:t})});var e=_.throttle(s.render.bind(s),500);o.$on("dashboardResize",function(){return e()}),o.$watch("showTime()",function(t){t?s.showDateSelection():s.hideDateSelection()}),o.onData=D,o.$on("$destroy",function(){return i.cancel()}),o.onSeriesSelectionChanged=w},o.data={},o.realtimeActiveInfo=u}t.$inject=["$scope","$timeout","RTAutoMove","gettext"],angular.module("c8y.core.measurements2").controller("c8yChartCtrl",t)}();