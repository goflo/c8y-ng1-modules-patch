"use strict";function _objectSpread(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?Object(arguments[e]):{},r=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(n).filter(function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable}))),r.forEach(function(e){_defineProperty(t,e,n[e])})}return t}function _defineProperty(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function _slicedToArray(e,t){return _arrayWithHoles(e)||_iterableToArrayLimit(e,t)||_unsupportedIterableToArray(e,t)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?_arrayLikeToArray(e,t):void 0}}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function _iterableToArrayLimit(e,t){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e)){var n=[],r=!0,o=!1,i=void 0;try{for(var a,c=e[Symbol.iterator]();!(r=(a=c.next()).done)&&(n.push(a.value),!t||n.length!==t);r=!0);}catch(e){o=!0,i=e}finally{try{r||null==c.return||c.return()}finally{if(o)throw i}}return n}}function _arrayWithHoles(e){if(Array.isArray(e))return e}!function(){function e(r,e,t,o,n,i,a,c,u){var l=_.memoize(function(){return e.all({configProperties:function(){var e=v("properties",[]);return _.filter(e,"__active").map(function(e){return angular.copy(e)})}(),discoveredProperties:function(){if(v("allowDisplayAndEditKnownProperties",!1))return o.list().then(function(e){return _.filter(e,y)}).then(function(e){return _.filter(e,p)});return[]}()}).then(function(e){var t=e.configProperties,n=e.discoveredProperties;return _(t).concat(n).uniqBy(function(e){return"".concat(_.get(e,"id"),"_").concat(_.get(e,"config._id"))}).reject(j).value()})});function f(){l.cache.clear(),r.$emit("stopRealtime"),function(){var e=r.child.config.device.id;return t.detailRealtime(e,r,void 0,{withChildren:!1}).then(function(e){r.managedObject=e})}().then(s).then(d).then(h)}function s(){return l().then(function(e){n.attach(r.managedObject,e)})}function d(){return l().then(function(e){return o.getSchema(e)}).then(function(e){r.schema=e})}function y(e){return 1===e.keyPath.length}function p(e){return _.has(r.managedObject,e.keyPath[0])}function h(){b(!0)}function b(t){return e.all({properties:l(),options:function(e){var t={};e&&(t.readonly=e,t.feedback=!1,t.disableSuccessState=!0,t.disableErrorState=!0);return t}(t)}).then(function(e){var t=e.properties,n=e.options;return o.getForm(t,n)}).then(function(e){r.form=e,r.editable=!t})}function m(e){!function(e){_.forEach(e,function(e){var t=_slicedToArray(e.keyPath,1),n=t[0];_.isUndefined(r.managedObject[n])&&(r.managedObject[n]=null)})}(e),l.cache.clear(),d().then(function(){return b(!1)})}function g(){a.changeTitle({title:_.get(r,"managedObject.name")||""})}function v(e,t){return _.get(r.child.config.options,e,t)}function j(e){var t=v("hiddenPropertiesKeyPaths",[]);return!!_.includes(t,e.keyPath[0])}r.$watch("child.config.options",f),_.assign(r,{startEdit:function(){r.managedObject=_.cloneDeep(r.managedObject),s(),b(!1)},canAddProperties:function(){return v("allowDisplayAndEditKnownProperties",!1)},addProperties:function(){var e={includeTree:!1,includeTreeChildren:!1,showComputed:!1,showRootPropertiesOnly:!0,managedObject:r.managedObject,hideExistingInMO:!0};return u.openSelector(e).then(m)},save:function(){return l().then(function(e){return _.reject(e,{computed:!0})}).then(function(e){return _objectSpread({id:r.managedObject.id},_.pick(r.managedObject,_.map(e,"keyPath[0]")))}).then(t.save).then(g).then(function(){return i.success(c("Changes saved."))}).then(f)},cancelEdit:function(){f()}})}e.$inject=["$scope","$q","c8yInventory","c8yPropertiesLibrary","c8yComputedProperties","c8yAlert","c8yTitle","gettext","SchemaPropertiesSvc"],angular.module("c8y.parts.assetPropertyWidget").controller("assetPropertyWidgetCtrl",e)}();