"use strict";function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_unsupportedIterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(e,r){if(e){if("string"==typeof e)return _arrayLikeToArray(e,r);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?_arrayLikeToArray(e,r):void 0}}function _iterableToArray(e){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e))return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e))return _arrayLikeToArray(e)}function _arrayLikeToArray(e,r){(null==r||r>e.length)&&(r=e.length);for(var n=0,t=new Array(r);n<r;n++)t[n]=e[n];return t}!function(){function e(e,r,n,N){l.$inject=["$q","$routeParams"],d.$inject=["$q","$location","$uibModal","c8yBase","c8yUser","c8yRoles","c8yUserRolesUi","c8yUserInventoryRoles","c8yUserUtil","c8yPermissions","c8yAlert","passwordStrengthCheckerFactory","gettextCatalog"];var t="c8y-user",o=["ROLE_USER_MANAGEMENT_READ","ROLE_USER_MANAGEMENT_ADMIN","ROLE_USER_MANAGEMENT_CREATE"],S=c(),C=c("/new"),L=c("/:userId"),a={template:"<c8y-user-list-view></c8y-user-list-view>"},i={priority:1e3,icon:t,name:N("Profile / Global roles"),template:'<c8y-user-detail-view user-id="$resolve.userId"></c8y-user-detail-view>',resolve:{userId:["$route",function(e){return e.current.params.userId}]}},u={priority:-1e3,icon:"c8y-atom",name:N("Application access"),template:'<c8y-user-application-access user="$resolve.user"></c8y-user-application-access>',resolve:{user:["$route","c8yUser","c8yBase",function(e,n,t){return n.detail(e.current.params.userId).then(t.getResData).then(function(r){return r.owner?n.detail(r.owner).then(t.getResData).then(function(e){return r._owner=e,r}).catch(function(){return r}):r})}]}},s={data:l};return{initUi:function(){e.addNavigation({parent:{name:N("Accounts"),icon:"c8y-accounts"},name:N("Users"),path:c().replace(/^\//,""),icon:t,priority:5e3,routerLinkExact:!1,showIfPermissions:{anyRole:o}}),r.when(S,a),r.when(C,i),r.when(L,i),r.when(L,u),n.addTitle(L,s)},$get:d};function c(e){return"/users".concat(e||"")}function l(e,r){return e.when({title:r.userId})}function d(i,r,n,t,u,o,e,a,s,c,l,d,f){var y,p=d();return u.current().then(function(e){y=e.id}),{ROUTE_NEW_USER:C,fullName:function(e){return"".concat(e.firstName||""," ").concat(e.lastName||"")},toggleExpanded:function(e){var n=!e._expanded;(e._expanded=n)||!function r(e){_.forEach(e,function(e){e._expanded=n,r(e._owns)})}(e._owns);return e},createUserFlatTree:s.createUserFlatTree,visibleInList:function(e){return!_.get(e,"owner")||_.get(e,"_owner._expanded")},expandAll:function(e){_.forEach(e,function(e){e._expanded=!0})},collapseAll:function(e){_.forEach(e,function(e){delete e._expanded})},detailLink:g,editUser:function(e){r.path(g(e))},search:s.search,changeUser:function(e,r){var n={changeGlobalRoles:h,copyInventoryRoles:v,enable:m,disable:A,remove:E,delegate:w,removeDelegate:T},t="string"==typeof r?r:_.get(r,"name");return _.get(n,t,i.reject)(e,_.get(r,"data"))},getPasswordStrength:p.getStrengthForColor,getPasswordColor:p.getHexColorForColor,getPasswordIcon:p.getIconForColor,isTfaAvailable:u.isTfaAvailable,gotoList:function(){r.path(S)},userHierarchyActive:s.userHierarchyActive,hasAppManagement:function(e){return c.hasAnyRole(["ROLE_APPLICATION_MANAGEMENT_READ","ROLE_APPLICATION_MANAGEMENT_ADMIN"],e)},isUndeletable:function(e){return y?U(e)||c.hasRole(e,"ROLE_TENANT_ADMIN"):void 0},isCurrent:U,EXTERNAL_ORIGIN_TEXT:N("You cannot edit the user since it is managed via your authorization server."),LOCAL_USER_TEXT:N("You are about to create a local user which will not be able to log in via single sign-on.")};function g(e){return L.replace(/:userId/,e.id)}function h(e,r){var n=_.map(r.roles,"id");return o.global.updateGroups(e,n)}function v(o){return i.all({copy:e.copyFromUserDialog(o),assignedRoles:u.listInventoryRoles(o)}).then(function(e){var r="replace"===e.copy.process,n=e.copy.roles,t=_.keyBy(e.assignedRoles.data.inventoryAssignments,"managedObject");return a.copyUserRoles(n,t,o,r)})}function A(e){return u.disable(e)}function m(e){return u.enable(e)}function E(r){var e=0<r.subusersCount;return n.open({component:"c8yUserRemovalModal",resolve:{user:function(){return r}}}).result.then(function(e){return e.deleteAll?function(e){return b(e,{deep:!0}).then(function(e){return e.reduce(function(e,r){return e.then(function(){return u.remove(r)})},i.resolve())})}(r):_.isUndefined(e.newOwner)?i.resolve():function(e,n){return b(e,{deep:!1}).then(function(e){return e.reduce(function(e,r){return e.then(function(){return u.save({id:r.id,owner:n})})},i.resolve())})}(r,e.newOwner)}).then(function(){return u.remove(r)}).then(function(){return function(e){return l.success(f.getString('User "{{userName}}" deleted.',e))}(r)}).then(function(){return{removeUser:!e,refresh:e}})}function b(e){var n=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};if(0===e.subusersCount)return i.resolve([]);var a=[];return u.list({owner:e.id,withSubusersCount:!0,pageSize:t.MAX_PAGESIZE}).then(function e(r){a.push.apply(a,_toConsumableArray(r));var n=r.statistics.pageSize,t=r.paging.next,o=r.length>=n;return t&&o?r.paging.next().then(e):i.resolve(a)}).then(function(e){if(!n.deep)return e;var r=e.map(function(e){return b(e,n)});return i.all([].concat(_toConsumableArray(e),_toConsumableArray(r))).then(_.flattenDeep)})}function w(e){return u.delegateTo(e).then(_.partial(R,e))}function R(e){return l.success(f.getString('You delegated to user "{{userName}}".',e))}function T(e){var r={id:e.id,delegatedBy:null};return u.save(r).then(_.partial(I,e))}function I(e){return l.success(f.getString('You removed delegation from user "{{userName}}".',e))}function U(e){return y&&y===e.id}}}e.$inject=["c8yNavigatorProvider","c8yViewsProvider","c8yTitleProvider","gettext"],angular.module("c8y.users").provider("c8yUsersUi",e)}();