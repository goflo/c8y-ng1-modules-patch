"use strict";function _objectSpread(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?Object(arguments[e]):{},r=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(n).filter(function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable}))),r.forEach(function(e){_defineProperty(t,e,n[e])})}return t}function _defineProperty(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_unsupportedIterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?_arrayLikeToArray(e,t):void 0}}function _iterableToArray(e){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e))return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e))return _arrayLikeToArray(e)}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}!function(){function e(a,f,e,n,t,r,i){var c;a.placeholder=i("Device's name or value of any device's property"),a.isDeviceSelected=a.isDeviceSelected||function(){return!(!_.isUndefined(A())||!a.selectRequired)},a.selectRoot=a.selectRoot||function(){m(c)},a.isSelectedRoot=a.isSelectedRoot||A,a.select=a.select||m,a.clickSelect=function(e){a.select(e,a),a.form&&(a.form.$setDirty(),a.form.$setValidity("deviceSelected",!0))},a.isSelected=a.isSelected||S,a.isSelectedById=a.isSelectedById||D,a.isSelectionEmpty=a.isSelectionEmpty||function(){return!a.selectedChildDevice},a.search=u,a.searchData={},a.propagateToggle={},a.icon=function(){return a.loading?"circle-o-notch":"search"},a.checkEnter=function(e){e.keyCode===I&&u(a.searchData.text)},a.getRootName=function(e){return e||i("Root Device")},a.emptySelectionAvailable=_.result(a,"emptySelectionAvailable")||!1,a.emptySelectionIcon=_.result(a,"emptySelectionIcon")||"",a.emptySelectionLabel=_.result(a,"emptySelectionLabel")||i("None"),a.readOnlyInfoText=_.result(a,"readOnlyInfo")||i("Selection change is disabled."),a.getScope=function(){return a},a.$watch("parent",o),a.$watch("selectedChildDevice",g),a.$on("selectDevice",C);function o(e,t){e&&(t&&e.id&&e.id===t||(_.isObjectLike(e)?f.when(e):r.detail(e).then(n.getResData)).then(function(e){return h(e),a.parentDevice=e,a.top&&(c=e,a.root=c,a.selectedChildDevice||!e.isDevice&&!a.groupsSelectable||(a.selectedChildDevice=e)),e}).then(y).then(v).then(l))}function l(e,t){var n=(a.children||[]).concat(e);a.children=_.uniqBy(n,"id"),a.truncated=!_.isUndefined(t)&&t}function u(e){a.propagateToggle.value=!1,_.remove(a.children,function(e){return!D(e)}),a.loading=!0,d({text:a.searchData.lastText=e}).then(s).finally(function(){a.loading=!1})}function d(e){var d=0,s=[];return r.list(_objectSpread({},e,{withParents:!0})).then(function e(t){d++;var n,r=t.statistics.pageSize,i=t.paging.next,c=t.length>=r,o=function(e){var t=function(e){return _(e).map(_.property("childDevices.references")).flatten().map(_.property("managedObject.id")).uniq().value()}(e);return _.filter(e,function(e){return e&&(D(e)||e.c8y_IsDevice||p(e)||function(e,t){return function(e){return _.get(e,"deviceParents.references.length")}(e)&&!_.includes(t,e.id)}(e,t))&&!function(e){return"c8y_OpcuaNode"===e.type}(e)})}(t),a=(s=[].concat(_toConsumableArray(s),_toConsumableArray(o))).length>r,l=i&&c;if(s.length>=r||10<=d||!l){var u=a||l;n=f.resolve({mos:_.take(s,r),truncated:u})}else n=t.paging.next().then(e);return n})}function s(e){var t=e.mos,n=e.truncated;return f.resolve(t).then(v).then(function(e){return l(e,n)})}function p(e){return!!e.c8y_IsDeviceGroup}function y(e){return t[p(e)?"childAssets":"childDevices"](e)}function h(e){var t=!p(e),n=t?"childDevices":"childAssets";return e.isDevice=t,e.__children=e[n]&&e[n].references||[],e}function v(e){return _.map(e,function(e){return h(e),D(e)&&m(e),a.parent&&(e.openChildren=!1,Array.isArray(a.parent.idPath)?(e.idPath=_.cloneDeep(a.parent.idPath),e.idPath.push(a.parent.id)):e.idPath=[a.parent.id]),e})}function g(e){if(e&&e.id){a.$parent.propagateToggle?a.propagateToggle=a.$parent.propagateToggle:a.propagateToggle={value:!0};var t=e.idPath?e.idPath[0]:e.id;!a.deviceSelectorForm.$dirty&&a.selectedChildDeviceId&&a.selectedChildDeviceId!==e.id&&a.deviceSelectorForm.$setDirty(),a.idPath=e.idPath,a.selectedChildDeviceId=e.id,a.children||!a.top||a.parent||d({ids:t}).then(s)}}function m(e,t){var n=["id","type","name"],r=t?[b(n,e)]:[];(t||a).$emit("selectDevice",r,n,e)}function b(e,n){return _.reduce(e,function(e,t){return e[t]=_.get(n,[t]),e},{})}function D(e){return e&&a.selectedChildDevice&&a.selectedChildDevice.id===e.id}function S(e){return D(e)}function A(){return S(c)||a.selectedChildDevice&&(c&&c.id)===a.selectedChildDevice.id}function C(e,t,n,r){var i=a.top?_.reduce(n,function(e,t){return e[t]="_root",e},{}):b(n,a.parentDevice);if(t.push(i),a.top){var c=t.reverse(),o=_.reduce(c[0],function(e,t,n){return e["path_".concat(n)]=_.map(c,n).join("/"),e},{});e.stopPropagation(),a.selectedChildDevice=r,a.contextPaths=o,a.onSelect({selDevice:r,contextPaths:o})}}_.assign(this,{$onInit:function(){void 0!==a.selectedChildDevice&&e(function(){a.form.$setValidity("deviceSelected",!0)},500)}});var I=13}e.$inject=["$scope","$q","$timeout","c8yBase","c8yDevices","c8yInventory","gettext"],angular.module("c8y.deviceSelector").controller("DeviceSelectorComboCtrl",e)}();