"use strict";function _objectSpread(n){for(var e=1;e<arguments.length;e++){var t=null!=arguments[e]?Object(arguments[e]):{},r=Object.keys(t);"function"==typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(t).filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),r.forEach(function(e){_defineProperty(n,e,t[e])})}return n}function _defineProperty(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}!function(){function e(t,e,c,r,i,n,u,a,o,s){var f="c8y_Kpi",l=["target","min","max","yellowRangeMin","yellowRangeMax","redRangeMin","redRangeMax"];function p(){return r.list({fragmentType:f,pageSize:u.MAX_PAGESIZE}).then(y)}function y(t){var e=_.constant(t);return a.mustHaveAnyRole(["ROLE_INVENTORY_ADMIN"]).then(function(){var e=_.filter(t,function(e){return!!_.isUndefined(e.c8y_Global)}),n=_.map(e,function(e){return function(){return g(e)}});return s.run(n,"Updating KPIs...").result.then(function(e){return"complete"!==e&&o.danger("Failed to update KPIs!"),t})},e)}function g(e){var n=_.cloneDeep(e);return delete n._measurement,n.c8y_Global={},r.save(n)}return{list:p,listByIds:function(n){return p().then(function(e){return n&&n.length?_.filter(e,function(e){return-1<n.indexOf(e.id)}):e})},detail:function(e){return r.detail(e).then(function(e){var n=e.data.c8y_Kpi;return _.forEach(l,function(e){_.isUndefined(n[e])||(n[e]=parseFloat(n[e]),Number.isNaN(Number(n[e]))&&delete n[e])}),e})},remove:r.remove,save:g,listKpiForDevice:function(e){var n=e.id||e;return r.getSupportedSeries(n).then(function(e){return t.all({kpis:function(e){var a=u.url("inventory/managedObjects/".concat(e,"/kpis"));return function e(n){var t=_.assign({pageSize:u.MAX_PAGESIZE},n),r={params:t},i=u.cleanListCallback("managedObjects",e,t);return c.get(a,r).then(i)}()}(n),series:e})}).then(function(e){var t=e.kpis,n=e.series;return{matchKpi:_.filter(t,function(e){return _.find(n,{fragment:e.c8y_Kpi.fragment,series:e.c8y_Kpi.series})}),nonKpiSeries:_.filter(n,function(n){return!_.find(t,function(e){return e.c8y_Kpi.fragment===n.fragment&&e.c8y_Kpi.series===n.series})})}})},getMeasurement:function(e,n){var t=e.c8y_Kpi||e,r=_objectSpread({},u.timeOrderFilter(),{source:n,valueFragmentType:t.fragment,valueFragmentSeries:t.series,pageSize:1,revert:!0});return i.list(r).then(_.head).then(function(e){return function(e){var n=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};return _objectSpread({kpi:e,time:n.time,source:n.source},_.get(n,e.fragment,{}))}(t,e)})}}}e.$inject=["$q","$log","$http","c8yInventory","c8yMeasurements","c8yUser","c8yBase","c8yPermissions","c8yAlert","c8yBatchOp"],angular.module("c8y.core").factory("c8yKpi",e)}();